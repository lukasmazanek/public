# CLAUDE.md

<!-- Last updated: 2026-01-02 -->

> **BKB Explorer** - Interactive Business Knowledge Blueprint Explorer
> **Status:** IN_PROGRESS | P1 Demo for BA presentation
> **Tech:** HTML, CSS, JavaScript (Cytoscape.js)

---

## Purpose

Presentation layer for Semantic Platform. Visualizes ontology data from ontology-lift as an interactive Business Knowledge Blueprint explorer.

BKB = Business Knowledge Blueprint
CST = ConceptSpeak Text (textual representation of ConceptSpeak visual language)

## Project Role

This is a **frontend-only** project - no server-side code. It consumes data generated by ontology-lift and presents it as an interactive Business Knowledge Blueprint with lazy loading per domain.

## Pipeline (follows ADR-065: Unified I/O Directory Convention)

```
ontology-lift/output/  →  bkb-explorer/input/  →  bkb-explorer/output/  →  bkb-explorer/js/  →  Browser
   (ontology.json)          (symlinks)              (copy)                  (bundles)           (lazy load)
```

**Pattern:** Each agent follows `input/ → output/` convention:
- `input/` - Read-only symlinks to previous agent's output
- `output/` - This agent's processed data (ontology.json)
- `js/` - Browser-ready bundles (data.js with window.BKB_LOADED)

## Data Source & Workflow

### 1. Initialize Input (symlinks from ontology-lift)

```bash
./init-input.sh
```

Creates symlinks: `input/Test → ../../semantic-platform/ontology-lift/output/Test`

Validates dependencies:
- conceptspeak (parser)
- domain-forge (consolidation, merging)
- ontology-lift (FIBO alignment, OWL export)

### 2. Process Domains

```bash
# Process all domains
./run.sh all

# Process single domain
./run.sh domain Test
./run.sh domain RBCZ:MIB:Investment
```

For each domain:
1. Copies `input/{domain}/ontology.json` → `output/{domain}/ontology.json`
2. Generates `js/{domain}/data.js` with `window.BKB_LOADED = {...}`
3. After all domains: generates `output/domains.js` (hierarchy)

### 3. Open Explorer

```bash
open index.html
```

Explorer lazy-loads domain data as needed from `js/{domain}/data.js`.

## Development

No build step required. Open `index.html` directly in browser (works offline).

```bash
# Full workflow
./init-input.sh    # Create symlinks (one-time)
./run.sh all       # Process all domains
open index.html    # View in browser
```

## Project Structure

```
bkb-explorer/
├── CLAUDE.md              # This file
├── README.md              # User documentation
├── index.html             # Main page
├── init-input.sh          # Initialize input symlinks (one-time)
├── run.sh                 # Process domains (input → output + js)
├── prepare-demo.sh        # Legacy: org data (private, never committed)
├── prepare-test-demo.sh   # Legacy: test data (public)
├── input/                 # Symlinks to ontology-lift/output/
│   ├── Test → ../../semantic-platform/ontology-lift/output/Test
│   └── RBCZ → ../../semantic-platform/ontology-lift/output/RBCZ
├── output/                # Processed data (copied from input)
│   ├── domains.js         # Domain hierarchy (generated)
│   ├── Test/
│   │   └── ontology.json
│   └── RBCZ/MIB/Investment/
│       └── ontology.json
├── js/                    # Browser-ready bundles
│   ├── Test/
│   │   └── data.js        # window.BKB_LOADED = {...}
│   ├── RBCZ/MIB/Investment/
│   │   └── data.js
│   ├── vendor/            # External libraries (offline)
│   │   ├── cytoscape.min.js
│   │   ├── dagre.min.js
│   │   └── cytoscape-dagre.min.js
│   ├── app.js             # Main application (lazy loads js/*/data.js)
│   ├── sidebar.js         # Domain tree navigation
│   ├── graph.js           # Cytoscape wrapper
│   ├── tooltip.js         # Hover cards
│   └── views.js           # View abstraction (ADR-040)
└── css/
    └── explorer.css       # Styles
```

## Components

| Component | File | Description |
|-----------|------|-------------|
| **App** | app.js | Main application, state management, lazy loading |
| **Sidebar** | sidebar.js | Domain tree navigation with Views |
| **Graph** | graph.js | Cytoscape.js canvas with nodes/edges |
| **Tooltip** | tooltip.js | Hover cards with definition, FIBO, cross-domain |
| **Views** | views.js | View abstraction - filter by source file (ADR-040) |
| **Data** | js/*/data.js | Per-domain bundles (lazy loaded) |
| **Hierarchy** | output/domains.js | Domain tree structure |

## Visual Rules

### Node Colors (ADR-058: Source-Based Notation)

Color indicates **who is authority for the definition**:

| Color | CSS Class | Meaning | Filter |
|-------|-----------|---------|--------|
| **Pastel Red** (#f8d7da) | `explicit-domain` | Pure domain concept (MOST IMPORTANT) | Domain |
| **Green** (#d5f4e6) | `fibo-def` | FIBO is authority | FIBO |
| **Cyan** (#d4f4f4) | `schema-def` | Schema.org is authority | Schema.org |
| **Blue** (#e3f2fd) | `explicit-aligned` | Local def + aligned | Domain |
| **Light Gray** (#eceff1) | `inherited` | Inherited from parent | Unknown |
| **Light Pink** (#fce4e7) | `draft` | Needs review (related to domain) | Unknown |

### Tooltip Badges

Two badges in tooltip header: `[SOURCE] [MAPPING]`

| Example | Meaning |
|---------|---------|
| `[EXPLICIT] [✓FIBO]` | Local definition, FIBO aligned |
| `[FIBO] [✓FIBO]` | FIBO is authority |
| `[EXPLICIT] [—]` | Pure domain, no external mapping |

### Other Visual Elements

| Element | Style |
|---------|-------|
| Node shape | rectangle |
| Ghost node | 50% opacity, dashed border |
| Edge extends | Solid, 4px, with arrow |
| Edge categorizes | Dashed, 2px |
| Property nodes | Orange, smaller |

## CSS Class Dependencies

**CRITICAL**: When changing node CSS classes in `getNodeClasses()`, you MUST also update:

| File | Function/Section | What to update |
|------|------------------|----------------|
| `graph.js` | `NODE_CLASSES` constant | Add/modify class names |
| `graph.js` | `getNodeClasses()` | Class assignment logic |
| `graph.js` | `applyFilter()` | Visibility filtering |
| `graph.js` | `getFilterCounts()` | Sidebar count logic |
| `explorer.css` | `:root` variables | Color definitions |
| `explorer.css` | `.legend-node.*` | Legend colors |
| `explorer.css` | `node.*` selectors | Cytoscape styles |
| `index.html` | Legend section | Legend labels |

**Grep before changing:**
```bash
grep -rn "hasClass.*fibo\|'fibo-def'\|'explicit" js/
```

## Rules

1. **Pure frontend** - no server-side code, no Node.js build
2. **Lazy loading** - domains loaded on-demand from js/*/data.js
3. **Works offline** - vendor libs bundled locally, file:// protocol support
4. **No external dependencies at runtime** - everything self-contained
5. **Keep it simple** - vanilla JS, no frameworks
6. **Follow I/O convention** - input/ (symlinks) → output/ (processed) → js/ (bundles)

## Testing

### Basic Functionality

- [ ] Sidebar tree expands/collapses
- [ ] Domain click loads graph
- [ ] Hover shows tooltip
- [ ] Click expands/collapses node
- [ ] Ghost nodes visible for cross-domain
- [ ] Portal navigation works
- [ ] View navigation filters concepts (ADR-040)
- [ ] View dropdown syncs with sidebar selection

### Visual Change Checklist (after CSS class changes)

**MUST verify after any change to node classes or colors:**

- [ ] Graf zobrazuje uzly (ne prázdný)
- [ ] Filtry v sidebaru ukazují nenulové počty
- [ ] Kliknutí na filtr checkbox skryje/zobrazí odpovídající uzly
- [ ] Barvy uzlů odpovídají legendě
- [ ] Tooltip zobrazuje dva badge: `[SOURCE] [MAPPING]`
- [ ] Legenda odpovídá skutečným barvám v grafu
- [ ] Test na více doménách (Test, Investment)

## Dependencies

| Library | Version | Purpose |
|---------|---------|---------|
| Cytoscape.js | 3.x | Graph visualization |
| Dagre | 0.8.x | Hierarchical layout |
| cytoscape-dagre | 2.x | Dagre integration |

## Related Documents

| Document | Location |
|----------|----------|
| Ontology data | ontology-lift/output/ |
| Pipeline | ontology-lift/README.md |
| ADR-065 | I/O Directory Convention |

## Scripts Reference

### init-input.sh

Initializes input symlinks from ontology-lift/output.

**Run once** or when ontology-lift output structure changes.

```bash
./init-input.sh
```

Creates:
- `input/Test → ../../semantic-platform/ontology-lift/output/Test`
- `input/RBCZ → ../../semantic-platform/ontology-lift/output/RBCZ`
- `input/Example → ../../semantic-platform/ontology-lift/output/Example`

### run.sh

Processes domains from input to output + js bundles.

**Modes:**
- `./run.sh all` - Process all domains (discovers automatically)
- `./run.sh domain Test` - Process single domain
- `./run.sh domain RBCZ:MIB:Investment` - Process nested domain

**Output per domain:**
- `output/{domain}/ontology.json` - Copied from input
- `js/{domain}/data.js` - Browser bundle with window.BKB_LOADED
- `output/domains.js` - Domain hierarchy (after all domains)

**Example:**
```bash
$ ./run.sh all
Initializing input directory symbolic links...
✓ Found ontology-lift output
✓ Input initialization complete

Discovering domains in input...
Found 5 domain(s):
  • Example
  • RBCZ:MIB:Allin
  • RBCZ:MIB:Investment
  • RBCZ:MIB:Retail
  • Test

[1/5] Processing domain: Example
  ✓ Copied ontology.json
  ✓ Generated example.js (15 + 0 concepts)
✓ Success: Example

...

═══════════════════════════════════════
✓ Success: 5
═══════════════════════════════════════

Generating domains hierarchy...
  ✓ Generated domains.js (5 domains)
  ✓ output/domains.js
```
